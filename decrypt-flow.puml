@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title Nitro Enclaves KMS 解密验证技术架构流程

participant "Parent Instance" as Parent
participant "Enclave" as Enclave
participant "KMS" as KMS

Parent -> Enclave: (1) 发送加密数据+签名+\n加密的 data key+credentials\n(vsock)
activate Enclave

Enclave -> Enclave: (2) KMS Decrypt\n(通过 vsock-proxy)\n(附带 attestation doc)
Enclave -> Parent: (3) 转发 KMS 请求\n(vsock-proxy)
activate Parent

Parent -> KMS: (4) 转发到 KMS
activate KMS

KMS --> Parent: (5) 返回解密的 data key
deactivate KMS

Parent --> Enclave: (6) 返回到 enclave
deactivate Parent

Enclave -> Enclave: (7) 获取明文 data key\n(kmstool 自动完成)

Enclave -> Enclave: (8) 解密数据\n(AES-256-GCM)

Enclave -> Enclave: (9) 验证签名\n(HMAC-SHA256)

Enclave --> Parent: (10) 返回解密结果和\n签名验证状态 (vsock)
deactivate Enclave

@enduml
