@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title Nitro Enclaves KMS 加密签名技术架构流程

participant "Parent Instance" as Parent
participant "Enclave" as Enclave
participant "KMS" as KMS

Parent -> Enclave: (1) 发送消息+credentials\n(vsock)
activate Enclave

Enclave -> Enclave: (2) 生成临时密钥对\n(公钥+私钥)
note right: 私钥保存在 enclave 内存\n永不离开 enclave

Enclave -> Enclave: (3) 构造 Attestation Document\n(包含公钥和 PCR 值)

Enclave -> Parent: (4) KMS GenerateDataKey 请求\n(通过 vsock-proxy)\n(附带 attestation doc)
activate Parent

Parent -> KMS: (5) 转发到 KMS
activate KMS
note right: Parent Instance\n无法解密 data key

KMS -> KMS: (6) 验证 attestation\n和 PCR 值

KMS --> Parent: (7) 返回两份加密的 data key:\n- CiphertextBlob (KMS key 加密)\n- CiphertextForRecipient (公钥加密)
deactivate KMS
note left: 加密的 data key\n在传输过程中安全

Parent --> Enclave: (8) 转发加密的 data key
deactivate Parent
note left: Parent Instance\n无法获取明文

Enclave -> Enclave: (9) 用私钥解密 data key\n(kmstool 自动完成)

Enclave -> Enclave: (10) 加密文本\n(AES-256-GCM)

Enclave -> Enclave: (11) 签名文本\n(HMAC-SHA256)

Enclave --> Parent: (12) 返回加密结果+签名+\nCiphertextBlob (vsock)
deactivate Enclave

@enduml
